<template>
    <section class="relative tabs bg-white p-6 rounded-lg w-4/5 mx-auto mb-6" id="tabs">
        <div class="info-test absolute">
			<div class="info-test__panel fixed">
				<vs-tooltip right>
					<div class="wrapp-icon p-3 flex items-center">
						<i class='bx bx-detail text-white'></i>
					</div>
					<template #tooltip>
						<div class="content-tooltip">
							<h4>
								Whats is Vuesax?
							</h4>
							<p>
								Vuesax is a framework of UI components created with Vuejs
							</p>
						</div>
					</template>
				</vs-tooltip>
			</div>
        </div>
        <div class="tabs-triggers flex space-x-2 w-full font-medium">
            <div
				class="tabs-trigger w-full p-4 px-5 pl-3 rounded-lg flex items-center justify-between cursor-pointer"
                 v-for="(item, index) in tabs"
                 :class="[index+1 === activeTab ? 'tabs-trigger--active' : '']" @click="activate(index+1)">
                <div class="tab-text">
                    <span class="step-block p-2 px-3 rounded mr-3">{{index+1}} шаг</span>{{tabs[index]}}
                </div>
                <i class="bx bx-chevron-right text-xl"></i>
            </div>
        </div>
        <div class="tabs-content tab pt-5 flex flex-col space-y-8" v-if="activeTab === 1">
            <div class="tab-data grid grid-cols-2 gap-3 mt-2">
                <h2 class="col-span-2 font-medium text-base">Основные данные</h2>
                <div class="cell flex items-center">
                    <vs-input v-model="nameTest" class="w-full" primary placeholder="название теста">
                        <template #icon>
                            <i class='bx bx-rename'></i>
                        </template>
                    </vs-input>
                </div>
                <div class="cell flex items-center">
                    <dropdown :listItems="listProjects" @add-item="addProject" :data="dataProject" @changeProject="changeProject"></dropdown>
                </div>
                <hr class="col-span-2 my-3 mt-4">
                <div v-if="testType === 0" class="list-type-test col-span-2">
                    <h2 class="font-medium text-base mb-3">Вид теста</h2>
                    <list-test-type @add-section="addSectionTest"></list-test-type>
                </div>
                <section-test-type v-else :type-test="testType"
                                   @reset-type-test="resetTypeTest"
                                   @next-step="activate(2)"></section-test-type>
            </div>
            <hr>
            <div class="navigation-buttons flex items-center justify-center">
                <vs-button class="w-max" primary @click="activate(2)">
                    К рекрутингу
                    <i class="bx bx-chevrons-right text-lg right"></i>
                </vs-button>
            </div>
        </div>
        <div class="tabs-content tab pt-5 flex flex-col space-y-8" v-if="activeTab === 2">
			<div class="tab-data flex flex-col space-y-2 mt-2">
				<h2 class="col-span-2 font-medium text-base">Способ рекрутинга</h2>
				<div class="type-recruiting">
					<input id="radio-link" type="radio" name="type-recruiting" class="hidden" checked>
					<label for="radio-link"
						   class="rounded-lg border-2 border-slate-100 w-full p-3 flex items-center space-x-3 cursor-pointer">
						<div class="radio-circle border-2 rounded-full relative"></div>
						<div class="data">
							<h3 class="font-medium text-base">Прохождение по ссылке</h3>
							<div class="flex items-center w-full space-x-2">
								<input ref="linkTest" type="text" name="test-url" id="test-url" :value="this.testLink" readonly
									   class="w-full text-slate-900 border-2 border-slate-100 rounded-lg hover:border-slate-200 px-3 py-2">
								<vs-button class="min-w-fit hover:no-underline" primary @click="copyLinkTest">
									<i class="bx bx-copy text-lg left"></i>
									скопировать
								</vs-button>
							</div>
						</div>
					</label>
				</div>
				<div class="type-recruiting">
					<input id="radio-team" type="radio" name="type-recruiting" class="hidden" checked>
					<label for="radio-team"
						   class="rounded-lg border-2 border-slate-100 w-full p-3 flex items-center space-x-3 cursor-pointer">
						<div class="radio-circle border-2 rounded-full relative w-full"></div>
						<div class="data">
							<h3 class="font-medium text-base mb-2">Рассылка по команде</h3>
							<div v-if="teams.length !== 0" class="list-teams w-full grid grid-cols-3 gap-3">
								<div  v-for="team in teams" class="team">
									<team-block :id="team.id" :name="team.name" :count_resp="team.count_resp"></team-block>
								</div>
							</div>
							<div v-else class="text-sm empty-teams text-center text-gray-500 h-full p-2 bg-slate-50 rounded-lg border border-slate-100">
								Вы еще не создали ни одной команды респондентов. Вероятнее всего вы хотите её
								<router-link :to="{name: 'ModeratorTeams'}">
									<a href="#" class="link link-blue size-14" @click="">создать сейчас</a>
								</router-link>
							</div>
						</div>
					</label>
				</div>
			</div>
			<hr>
			<div class="navigation-buttons flex items-center justify-center">
				<vs-button class="w-max" primary @click="activate(3)">
					<i class="bx bx-rocket text-lg left"></i>
					Запустить тест
				</vs-button>
			</div>
        </div>
        <div class="tabs-content tab pt-5 flex flex-col space-y-8" v-if="activeTab === 3">
            <div class="filter-section p-3 transition ease-in-out">
				<div class="filter-section__button cursor-pointer flex justify-between" @click="switchStateFilter">
					<div class="filter-section__title flex items-center">
						<i class='bx bx-slider-alt text-slate-400 text-xl mr-2'></i>
						<span class="font-medium">
							Фильтр данных респондентов
						</span>
						<i class='bx ml-1' :class="[
							this.stateFilter ? 'bx-chevron-up' : 'bx-chevron-down'
						]"></i>
					</div>
					<div class="count-respondents flex items-center text-sm">
						<span class="text-slate-500 mr-2">Выборка:</span>
						<p class="font-bold">{{formattingNumber(20394)}}</p>
						<span class="text-slate-500 ml-1">респондентов</span>
					</div>
				</div>
				<div class="filter-section__data rounded-lg border-2 border-slate-100
						overflow-hidden transition p-3 mt-3 " :class="[
					this.stateFilter ? '' : 'hidden'
				]">
					<div class="column flex flex-col w-full">
						<div class="row grid grid-cols-2 gap-3 pt-6 w-full">
							<vs-select
								filter
								collapse-chips
								multiple
								placeholder="Название страны"
								v-model="resultsFilters.country"
								label="Страна"
								class="w-full"
							>
								<template v-for="(country, index) in this.getListCountries">
									<vs-option :label="country.name_ru" :value="index+1">
										{{country.name_ru}} <span class="text-slate-400">&nbsp;{{country.iso_code2}}&nbsp;</span>
									</vs-option>
								</template>
							</vs-select>
							<vs-select
								filter
								multiple
								collapse-chips
								v-model="resultsFilters.gender"
								placeholder="Пол респондентов"
								label="Пол"
								class="w-full"
							>
								<vs-option label="Мужской" value="male">
									Мужской
								</vs-option>
								<vs-option label="Женский" value="female">
									Женский
								</vs-option>
							</vs-select>
						</div>
						<div class="row grid grid-cols-2 gap-3 pt-8 w-full">
							<vs-select
								filter
								multiple
								collapse-chips
								placeholder="Ваше образование"
								v-model="resultsFilters.educations"
								label="Образование"
								class="w-full"
							>
								<template v-for="education in this.getListEducations">
									<vs-option :label="education.name" :value="education.id">
										{{education.name}}
									</vs-option>
								</template>
							</vs-select>
							<vs-select
								filter
								multiple
								collapse-chips
								placeholder="Трудоустройство"
								v-model="resultsFilters.statusEmp"
								label="Статус трудоустройства"
								class="w-full"
							>
								<template v-for="statusEmp in this.getListStatusEmp">
									<vs-option :label="statusEmp.name" :value="statusEmp.id">
										{{statusEmp.name}}
									</vs-option>
								</template>
							</vs-select>
						</div>
						<div class="row grid grid-cols-2 gap-3 pt-8 w-full">
							<vs-select
								filter
								placeholder="Название индустрии"
								v-model="industry"
								label="Индустрия"
								class="w-full"
							>
								<template v-for="industry in this.getListIndustries">
									<vs-option :label="industry.name" :value="industry.id">
										{{industry.name}}
									</vs-option>
								</template>
							</vs-select>
							<vs-select
								filter
								collapse-chips
								multiple
								placeholder="Название проф.области"
								v-model="resultsFilters.workArea"
								label="Название проф.области"
								class="w-full"
							>
								<template v-for="workArea in this.listWorkAreas">
									<vs-option :label="workArea.name" :value="workArea.id" :key="workArea.id">
										{{workArea.name}}
									</vs-option>
								</template>
							</vs-select>
						</div>
						<div class="row grid grid-cols-2 gap-3 pt-8 w-full">
							<vs-select
								placeholder="Ваша техническая подготовка"
								multiple
								filter
								v-model="resultsFilters.techPrep"
								label="Техническая подготовка"
								class="w-full"
							>
								<template v-for="techPrep in this.getListTechPrep">
									<vs-option :label="techPrep.name" :value="techPrep.id" :key="techPrep.id">
										{{techPrep.name}}
									</vs-option>
								</template>
							</vs-select>
						</div>
					</div>
				</div>
			</div>
        </div>
    </section>
</template>

<script>
    import Dropdown from "./Dropdown/Dropdown";
    import SectionTestType from "./SectionTestType";
    import ListTestType from "./ListTestType";
    import TeamBlock from "./TeamBlock";
	import listCountries from "../../../../../mocks/countries"
	import listEducations from "../../../../../mocks/usersCriteries/educations"
	import listStatusEmp from "../../../../../mocks/usersCriteries/statusEmp"
	import listIndustries from "../../../../../mocks/usersCriteries/industries"
	import listTechPrep from "../../../../../mocks/usersCriteries/techPrep"

    export default {
        name: "AddTest",
        components: {
            ListTestType,
            SectionTestType,
            Dropdown,
			TeamBlock
        },
        data: ()=>({
            activeTab: 3,
            tabs: [
                "Построение",
                "Рекрутинг",
                "Результаты",
            ],
            nameTest: '',
            listProjects: [
                { value: 'Дизайн приложений', id: 1 },
                { value: 'Упаковки', id: 2 },
                { value: '123', id: 3 },
                { value: '435', id: 4 },
                { value: '57', id: 5 },
                { value: '45646', id: 6 },
            ],
            dataProject: {id:null,value:null},
            testType: 0,
			testInstruction: null,
			testFiles: [],
			testLink: 'https://app.usabilityhub.com/tests/2a303ea9824c/recruit',
			teams: [
				{
					id: 1,
					name: "Team's name 1",
					count_resp: 20434
				},
				{
					id: 2,
					name: "Team's name 2",
					count_resp: 34435
				},
				{
					id: 3,
					name: "Team's name 3",
					count_resp: 20434534
				},
			],
			stateFilter: false,
			respondents: [
				{
					id: 1,
					country: 12,
					gender: 'male',
					age: '25',
					education: 1,
					statusEmp: 1,
					workArea: 2,
					techPrep: 3
				},
				{
					id: 2,
					country: 12,
					gender: 'female',
					age: '34',
					education: 2,
					statusEmp: 3,
					workArea: 2,
					techPrep: 3
				},
				{
					id: 3,
					country: 12,
					gender: 'female',
					age: '56',
					education: 2,
					statusEmp: 3,
					workArea: 2,
					techPrep: 3
				},
			],
			industry: '',
			listWorkAreas: [],
			resultsFilters: {
            	country: [],
				gender: [],
				educations: [],
				statusEmp: [],
				workArea: [],
				techPrep: []
			}
        }),
        methods: {
            activate(index) {
                this.activeTab = index;
            },
            addProject(data) {
                let nameNewProject = data.input.value
                let idNewProject = data.listProjects.length+1
                this.listProjects.push({
                    value: nameNewProject,
                    id:  idNewProject
                })
				this.setDataProject(
					{
						value: nameNewProject,
						id: idNewProject
					}
				)
            },
			changeProject(data){
				this.setDataProject(data)
			},
			setDataProject(data){
				this.dataProject.value = data.value
				this.dataProject.id = data.id
			},
            addSectionTest(id){
                console.log('Test type: ', this.testType = id)
            },
            resetTypeTest(){
                this.testType = 0
                this.activate(1)
            },
			copyLinkTest(){
            	let link = this.$refs.linkTest.value
				if (link) {
					navigator.clipboard.writeText(link)
						.then(() => {
							this.openNotification('top-center', 'success', `<i class='bx bx-check'></i>`)
						})
						.catch(err => {
							console.log('Something went wrong', err);
						})
				}
			},
			openNotification(position = null, color, icon) {
				const noti = this.$vs.notification({
					icon,
					color,
					position,
					title: 'Ссылка скопирована!',
					text: `Теперь респонденты смогут добраться до вашего теста по ссылке`
				})
			},
			switchStateFilter(){
            	this.stateFilter = !this.stateFilter
			},
			getWorkAreas(){
				this.listWorkAreas.length = 0
				this.resultsFilters.workArea.length = 0
				this.listWorkAreas = listIndustries.find(item => item.id === this.industry).workAreas
			}
        },
		computed: {
			getListCountries() {
				return listCountries
			},
			getListEducations() {
				return listEducations
			},
			getListStatusEmp() {
				return listStatusEmp
			},
			getListIndustries() {
				return listIndustries
			},
			getListTechPrep(){
				return listTechPrep
			}
		},
		watch: {
			industry(){
				this.getWorkAreas()
			},
			resultsFilters(){
				console.log('!!!')
			}
		}
    }
</script>

<style lang="scss" scoped>
    @import "../../../../../../sass/variables";

    .info-test {
		left: -42px;
		top: 0;
		height: 100%;

		&__panel {
			top: 20%;
			background: $primary;
			border-radius: 10px 0 0 10px;
		}
    }

    .tabs {
        @include default-shadow();

        &-trigger {
            background: $gray-100;
            transition: .3s;
            color: $gray-600;

            & .step-block{
                  background: $gray-200;
                  color: $gray-600;
              }

            &--active {
                 background: $gradient;
                 color: white;

                & .step-block{
                      background: white;
                      color: $primary;
                  }
            }
        }
    }

	.type-recruiting .data {
		width: 95%;
	}

	.type-recruiting .radio-circle {
		width: 20px;
		height: 20px;

		&:before {
			content: "";
			display: inline-block;
			width: 10px;
			height: 10px;
			position: absolute;
			background: white;
			left: 3px;
			top: 3px;
			border-radius: 999px;
		}
	}

	/* Checked */
	.type-recruiting input[type=radio]:checked + label .radio-circle:before {
		background: $primary;
		//border-color: $primary;
		box-shadow: 0 0 10px 1px $primary;
	}

	.type-recruiting input[type=radio]:not(:checked) + label .data {
		opacity: .5;
	}


</style>
